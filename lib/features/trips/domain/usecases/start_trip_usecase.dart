import 'package:dartz/dartz.dart';
import '../../../../core/errors/failures.dart';
import '../../../../core/utils/logger.dart';
import '../entities/trip_entity.dart';
import '../entities/location_entity.dart';
import '../repositories/route_repository.dart';
import '../repositories/trip_repository.dart';

/// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
/// ๐ฃ๏ธ StartTripUseCase - ุญุงูุฉ ุงูุงุณุชุฎุฏุงู: ุจุฏุก ุฑุญูุฉ ุฌุฏูุฏุฉ (Domain Layer)
/// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
///
/// ุงููุฏู ูู ูุฐุง ุงูููู:
/// ูุฐุง ุงูููู ููุซู **ูุธููุฉ ูุญุฏุฏุฉ ุฌุฏุงู** ูู ุงูุชุทุจูู:
/// "ุจุฏุก ุฑุญูุฉ ุฌุฏูุฏุฉ ุนูู ูุณุงุฑ ูุนูู"
///
/// ููุท Use Case:
/// Use Case = ูุฆุฉ ุชููุฐ ุญุงูุฉ ุงุณุชุฎุฏุงู ูุงุญุฏุฉ ููุท
/// ููุงุฐุงุ ููุท Single Responsibility Principle (SRP)
/// โ ูู class ูุณุคูู ุนู ุดูุก ูุงุญุฏ ููุท
/// โ ุณูู ุงูุงุฎุชุจุงุฑ (Testing)
/// โ ุณูู ุงูุตูุงูุฉ
/// โ ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุงูููุฏ
///
/// ุงููุฑู ุจูู Use Case ู Repository:
/// - **Repository**: ูุงุฌูุฉ ุนุงูุฉ ููุจูุงูุงุช (CRUD operations)
///   ูุซูุงู: getRoute(), updateRoute(), deleteRoute()
/// 
/// - **Use Case**: ููุทู ุฃุนูุงู ูุญุฏุฏ
///   ูุซูุงู: ุจุฏุก ุฑุญูุฉ (ููุทูู ุนูู ุนุฏุฉ ุนูููุงุช ูุนุงู)
///
/// ุฏูุฑุฉ ุญูุงุฉ ูุฐุง Use Case:
/// ```
/// UI (TripPage)
///   โ ูุถุบุท "ุงุจุฏุฃ ุงูุฑุญูุฉ"
/// TripBloc.add(StartTripEvent)
///   โ ูุณุชุฏุนู
/// startTripUseCase.call()
///   โ ูุฐู ุงูุฏุงูุฉ ุชูุนู ุนุฏุฉ ุฃุดูุงุก:
///     1. ุชุญูู ูู ุนุฏู ูุฌูุฏ ุฑุญูุฉ ูุดุทุฉ
///     2. ุฌูุจ ุจูุงูุงุช ุงููุณุงุฑ
///     3. ุฅูุดุงุก ุฑุญูุฉ ุฌุฏูุฏุฉ
///     4. ุญูุธูุง ูู Database
///   โ ุงููุชูุฌุฉ
/// Either<Failure, TripEntity>
///   โ ุฅุฐุง ูุฌุญุช
/// emit(TripActive(trip))
///   โ ุชุญุฏูุซ ุงูุดุงุดุฉ
/// MapPage ุชุนุฑุถ ุงูุฑุญูุฉ ุงููุดุทุฉ ูุน ุงููููุน ุงูุญุงูู
/// ```
///
/// ูุซุงู ุงูุนููู:
/// ```
/// ุงููุณุชุฎุฏู ูู ุชุทุจูู PSGA:
/// 1. ูุฎุชุงุฑ ูุณุงุฑ ูู ุงููุงุฆูุฉ
/// 2. ูุถุบุท ุฒุฑ "ุงุจุฏุฃ ุงูุฑุญูุฉ"
/// 3. ุงูุชุทุจูู ูุชุญูู:
///    - ูู ููุงู ุฑุญูุฉ ูุดุทุฉ ุจุงููุนูุ (ูุง ูููู ุฑุญูุชุงู ูุนุงู!)
///    - ูู ุงููุณุงุฑ ููุฌูุฏ ูุตุญูุญุ
/// 4. ุฅุฐุง ูู ุดูุก ุชูุงู:
///    - ููุดุฆ ุฑุญูุฉ ุฌุฏูุฏุฉ
///    - ูุจุฏุฃ ุชุชุจุน ุงููููุน
///    - ููุชูู ูุฎุฑูุทุฉ ุงูุฑุญูุฉ
/// ```

class StartTripUseCase {
  /// ๐ ุงูุงุนุชูุงุฏูุงุช (Dependencies)
  /// ููุงุฐุง ูุญุชุงุฌ ูุฐูู Repositoryุ
  /// 
  /// 1๏ธโฃ tripRepository:
  ///    - ูุฅูุดุงุก ุงูุฑุญูุฉ ุงูุฌุฏูุฏุฉ
  ///    - ูุชุนุงูู ูุน ุงูุจูุงูุงุช ุงููุญููุฉ (Hive) ูุงูุณุญุงุจูุฉ (Firebase)
  ///    - ูููุฑ ูุงุฌูุฉ ููุญุฏุฉ ุฏูู ุงูููู ูู ุงูุชูุงุตูู
  /// 
  /// 2๏ธโฃ routeRepository:
  ///    - ููุชุญูู ูู ุฃู ุงููุณุงุฑ ููุฌูุฏ
  ///    - ุงูุญุตูู ุนูู ุจูุงูุงุช ุงููุณุงุฑ (ุงูุงุณูุ ุงูููุงุทุ ุฅูุฎ)
  ///    - Reason: ูุง ูููู ุจุฏุก ุฑุญูุฉ ุนูู ูุณุงุฑ ุบูุฑ ููุฌูุฏ!
  /// 
  /// ููุท Dependency Injection:
  /// ุจุฏูุงู ูู ุฅูุดุงุก Repositories ููุง:
  ///   โ BAD:  final repo = TripRepositoryImpl();
  /// ููุฑุฑูุง ูู ุงูุฎุงุฑุฌ:
  ///   โ GOOD: ุงูู Constructor ูุฃุฎุฐูุง ููุนุงููุงุช
  /// ููุงุฐุงุ ุณูููุฉ ุงูุงุฎุชุจุงุฑ + ุงููุฑููุฉ (ูููู ุงุณุชุจุฏุงู ุจู Mock)
  
  final TripRepository tripRepository;
  final RouteRepository routeRepository;

  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  /// Constructor - ุชููุฆุฉ Use Case
  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  /// 
  /// ุงูุชูููุน:
  /// ```
  /// StartTripUseCase({
  ///   required this.tripRepository,
  ///   required this.routeRepository,
  /// });
  /// ```
  /// 
  /// ูุนูู "required":
  /// ูุฐู ุงููุนุงููุงุช ุฅุฌุจุงุฑูุฉ (ูุง ูููู ุญุฐููุง)
  /// ูุฃููุง ูุง ูุณุชุทูุน ุจุฏุก ุฑุญูุฉ ุจุฏูู ูุนุฑูุฉ ุฃูู ูุญูุธูุง (Repositories)
  
  StartTripUseCase({
    required this.tripRepository,
    required this.routeRepository,
  });

  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  /// call() - ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ: ุจุฏุก ุฑุญูุฉ ุฌุฏูุฏุฉ
  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  ///
  /// ูุนุงููุงุช ุงูุฏุงูุฉ:
  /// 
  /// [routeId]: ูุนุฑู ุงููุณุงุฑ ุงูุฐู ุชุฑูุฏ ุจุฏุก ุฑุญูุฉ ุนููู
  ///   ูุซุงู: "route_123"
  /// 
  /// [userId]: ูุนุฑู ุงููุณุชุฎุฏู ุงูุฐู ูุจุฏุฃ ุงูุฑุญูุฉ
  ///   ูุซุงู: "user_456"
  ///   ููุงุญุธุฉ: ูุณุชุฎุฏูู ููุชุญูู ูู ุฃู ุงูุฑุญูุฉ ูููู ููุท
  /// 
  /// [currentLocation]: ุงููููุน ุงูุญุงูู ูููุณุชุฎุฏู
  ///   ูุซู: LocationEntity(lat: 24.7136, lng: 46.6753)
  ///   ููุงุญุธุฉ: ูุฐุง ูู ุงููููุน ุงูุฃููู ููุฑุญูุฉ (ููุทุฉ ุงูุจุฏุงูุฉ)
  ///
  /// ุงูุฅุฑุฌุงุน:
  /// Future<Either<Failure, TripEntity>>
  ///
  /// ูุนูู Either:
  /// - Left = ูุดู โ (ูุญุชูู ุนูู ุฑุณุงูุฉ ุงูุฎุทุฃ)
  /// - Right = ูุฌุงุญ โ (ูุญุชูู ุนูู ุจูุงูุงุช ุงูุฑุญูุฉ ุงูุฌุฏูุฏุฉ)
  /// 
  /// ูุซุงู:
  /// - ุฅุฐุง ูุงู ููุงู ุฑุญูุฉ ูุดุทุฉ ุจุงููุนู:
  ///   โ Left(ValidationFailure("ููุฌุฏ ุฑุญูุฉ ูุดุทุฉ ุจุงููุนู"))
  /// 
  /// - ุฅุฐุง ูุฌุญุช ุงูุนูููุฉ:
  ///   โ Right(TripEntity(id: "trip_789", status: active, ...))
  ///
  /// ูุนูู async:
  /// ูุฐู ุงูุฏุงูุฉ ุชุฃุฎุฐ ููุชุงู (ูุฏ ุชุญุชุงุฌ ููุฅูุชุฑูุช ููุชุญูู ูู Firebase)
  /// ูุฐูู ูุฑุฌุน Future (ุงูุชุฒุงู ุจุงููุชูุฌุฉ ูุงุญูุงู)
  
  Future<Either<Failure, TripEntity>> call({
    required String routeId,
    required String userId,
    required LocationEntity currentLocation,
  }) async {
    /// 1๏ธโฃ ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุฑุญูุฉ ูุดุทุฉ ุจุงููุนู
    /// 
    /// ููุงุฐุง ูุฐุง ุงูุชุญููุ
    /// ุงููุณุชุฎุฏู ูุง ูููู ุฃู ูููู ูู ุฑุญูุชูู ูู ููุณ ุงูููุช!
    /// (ูุง ููููู ุฃู ุชููู ูู ุฑุญูุชูู ูุนุงู)
    /// 
    /// ุงูุทูุจ: ุงุณุฃู Repository ุนู ุขุฎุฑ ุฑุญูุฉ ูุดุทุฉ ููุฐุง ุงููุณุชุฎุฏู
    /// ุงููุชูุฌุฉ: Either<Failure, TripEntity?> (ูุฏ ุชููู null = ูุง ุฑุญูุฉ)
    
    AppLogger.info('[Trip] ุฌุงุฑู ุงูุชุญูู ูู ุงูุฑุญูุงุช ุงููุดุทุฉ...');
    final activeTripResult = await tripRepository.getActiveTrip(userId);

    /// ูุนุงูุฌุฉ ุงููุชูุฌุฉ ุจุงุณุชุฎุฏุงู fold:
    /// fold ุชุนูู: ุงุฎุชุฑ ุจูู ุงููุดู ุฃู ุงููุฌุงุญ
    return activeTripResult.fold(
      /// โ Case 1: ูุดู ูู ุฌูุจ ุงูุฑุญูุฉ ุงููุดุทุฉ (ูุซูุงู ุฎุทุฃ ูู Database)
      /// failure = object ูุญุชูู ุนูู ุฑุณุงูุฉ ุงูุฎุทุฃ
      (failure) => Left(failure),
      
      /// โ Case 2: ูุฌุญ ุงูุฌูุจ (ูุฏ ุชููู activeTrip = null ุฃู ุชุญุชูู ุฑุญูุฉ)
      /// activeTrip = ุงูุฑุญูุฉ ุงููุดุทุฉ (ุฃู null ุฅุฐุง ูู ุชูู ููุงู ุฑุญูุฉ)
      (activeTrip) async {
        /// 2๏ธโฃ ุงูุชุญูู: ูู ููุงู ุฑุญูุฉ ูุดุทุฉุ
        /// ุฅุฐุง ูุงูุช != null ูุนูุงู ููุฌุฏ ุฑุญูุฉ ูุดุทุฉ ุจุงููุนู!
        if (activeTrip != null) {
          AppLogger.warning('[Trip] ููุฌุฏ ุฑุญูุฉ ูุดุทุฉ ุจุงููุนู');
          /// ูุฑุฌุน ุฎุทุฃ: ุงููุณุชุฎุฏู ูุง ููููู ุจุฏุก ุฑุญูุฉ ุฌุฏูุฏุฉ
          return const Left(ValidationFailure(message: 'ููุฌุฏ ุฑุญูุฉ ูุดุทุฉ ุจุงููุนู'));
        }

        /// 3๏ธโฃ ุฌูุจ ุจูุงูุงุช ุงููุณุงุฑ ุงูุฃุตูู
        /// 
        /// ููุงุฐุง ูุญุชุงุฌ ุงููุณุงุฑุ
        /// - ููุชุญูู ูู ุฃูู ููุฌูุฏ โ
        /// - ููุญุตูู ุนูู ุงุณูู ูุจูุงูุงุชู
        /// - ููุฑุจุท ุจูู ุงูุฑุญูุฉ ูุงููุณุงุฑ
        /// - ูุชุญุฏูุซ ุนุฏุฏ ูุฑุงุช ุงุณุชุฎุฏุงู ุงููุณุงุฑ
        /// 
        /// ุงูุทูุจ: ุงุณุฃู RouteRepository ุนู ุงููุณุงุฑ ุจู ID
        
        AppLogger.info('[Trip] ุฌุงุฑู ุฌูุจ ุจูุงูุงุช ุงููุณุงุฑ...');
        final routeResult = await routeRepository.getRoute(routeId);

        /// ูุนุงูุฌุฉ ูุชูุฌุฉ ุฌูุจ ุงููุณุงุฑ:
        return routeResult.fold(
          /// โ ุงููุณุงุฑ ุบูุฑ ููุฌูุฏ ุฃู ุญุฏุซ ุฎุทุฃ
          (failure) {
            AppLogger.error('[Trip] ุงููุณุงุฑ ุบูุฑ ููุฌูุฏ');
            return Left(failure);
          },
          
          /// โ ุชู ุฌูุจ ุจูุงูุงุช ุงููุณุงุฑ ุจูุฌุงุญ
          /// route = ุจูุงูุงุช ุงููุณุงุฑ ุงููุงููุฉ
          (route) async {
            /// 4๏ธโฃ ุฅูุดุงุก ุงูุฑุญูุฉ ูุงูุจุฏุก ุจูุง
            /// 
            /// ุงูุฎุทูุงุช:
            /// - ุงุณุชุฏุนุงุก tripRepository.startTrip()
            /// - ูุฐุง Repository ุณูุชููู:
            ///   1. ุฅูุดุงุก TripModel (ูุณุฎุฉ database-ready ูู TripEntity)
            ///   2. ุญูุธูุง ูู Hive (Database ูุญูู)
            ///   3. ุฅุถุงูุฉ sync item ูู SyncManager (ููุฒุงููุฉ Firebase ูุงุญูุงู)
            ///   4. ุชุญุฏูุซ ุนุฏุฏ ูุฑุงุช ุงุณุชุฎุฏุงู ุงููุณุงุฑ
            
            AppLogger.info('[Trip] ุจุฏุก ุฑุญูุฉ ุนูู ุงููุณุงุฑ: ${route.name}');

            /// ุงุณุชุฏุนุงุก Repository ูุจุฏุก ุงูุฑุญูุฉ
            /// ูุฑุฌุน: Either<Failure, TripEntity>
            final result = await tripRepository.startTrip(
              routeId,
              currentLocation,
            );

            /// ูุนุงูุฌุฉ ุงููุชูุฌุฉ (ููู Logging ููุท)
            /// ุงููุชูุฌุฉ ุงูููุงุฆูุฉ ุณูุชู ุฅุฑุฌุงุนูุง ููู BLoC
            result.fold(
              (failure) => AppLogger.error('[Trip] ูุดู ุจุฏุก ุงูุฑุญูุฉ: ${failure.message}'),
              (trip) => AppLogger.success('[Trip] ุชู ุจุฏุก ุงูุฑุญูุฉ ุจูุฌุงุญ ุนูู ุงููุณุงุฑ: ${route.name}'),
            );

            /// 5๏ธโฃ ุฅุฑุฌุงุน ุงููุชูุฌุฉ ููู BLoC
            /// ุณูุนุงูุฌูุง BLoC ููุตุฏุฑ State ุฌุฏูุฏ
            /// ุฅูุง: TripActive(trip) ุฃู TripError(message)
            return result;
          },
        );
      },
    );
  }
}

/// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
/// ููุฎุต ุชุฏูู ุงูุจูุงูุงุช ุงููุงูู:
/// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
/// 
/// 1. UI (MapPage):
///    ุงููุณุชุฎุฏู ูุถุบุท "ุงุจุฏุฃ ุงูุฑุญูุฉ"
///    
/// 2. TripBloc.add(StartTripEvent(routeId, userId, location)):
///    TripBloc ูุณุชูุจู ุงูุญุฏุซ
///    
/// 3. TripBloc._onStartTrip():
///    BLoC ูุณุชุฏุนู: startTripUseCase.call(...)
///    
/// 4. StartTripUseCase.call():
///    โ ุชุญูู: ูู ููุงู ุฑุญูุฉ ูุดุทุฉุ
///    โ ุฌูุจ: ุจูุงูุงุช ุงููุณุงุฑ
///    โ ุฅูุดุงุก: ุฑุญูุฉ ุฌุฏูุฏุฉ
///    โ ุญูุธ: ูู Hive + Sync Queue
///    
/// 5. ุงููุชูุฌุฉ: Either<Failure, TripEntity>
///    
/// 6. TripBloc ูุนุงูุฌุฉ ุงููุชูุฌุฉ:
///    โ emit(TripActive(trip))
///    
/// 7. BlocBuilder ูุฑู ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ:
///    โ ูุญุฏุซ ุงููุงุฌูุฉ
///    โ ูุนุฑุถ ุฎุฑูุทุฉ ุงูุฑุญูุฉ
/// 
/// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
