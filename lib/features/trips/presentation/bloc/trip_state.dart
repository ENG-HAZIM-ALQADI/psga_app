import 'package:equatable/equatable.dart';
import '../../domain/entities/trip_entity.dart';
import '../../domain/entities/deviation_entity.dart';

/// ═══════════════════════════════════════════════════════════════════════════
/// 📊 TripState - حالات الرحلات (Presentation Layer)
/// ═══════════════════════════════════════════════════════════════════════════
///
/// الهدف من هذا الملف:
/// تعريف جميع الحالات (States) الممكنة للرحلة
///
/// ما هي الحالات؟
/// → تمثيل الحالة الحالية للرحلة في كل لحظة
/// الواجهة تستمع لهذه الحالات وتعرض معلومات مناسبة
///
/// دورة الحالات الرئيسية:
/// ```
/// TripInitial (البداية)
///     ↓
/// TripLoading (جاري التحميل)
///     ↓
/// TripActive (رحلة نشطة) ← يمكن الانتقال إلى:
///     ├→ TripPaused (موقوفة)
///     ├→ DeviationDetected (انحراف)
///     └→ TripCompleted (انتهت)
/// ```
///
/// استخدام في الواجهة:
/// ```dart
/// BlocBuilder<TripBloc, TripState>(
///   builder: (context, state) {
///     if (state is TripLoading) return LoadingWidget();
///     if (state is TripActive) return MapWidget(trip: state.trip);
///     if (state is TripError) return ErrorMessage(state.message);
///     return SizedBox.shrink();
///   },
/// )
/// ```

abstract class TripState extends Equatable {
  const TripState();

  @override
  List<Object?> get props => [];
}

/// ═══════════════════════════════════════════════════════════════════════════
/// 🏁 TripInitial - الحالة الأولية
/// ═══════════════════════════════════════════════════════════════════════════
/// متى تحدث؟ عند فتح التطبيق (لا توجد رحلة جارية)

class TripInitial extends TripState {}

/// ═══════════════════════════════════════════════════════════════════════════
/// ⏳ TripLoading - جاري التحميل
/// ═══════════════════════════════════════════════════════════════════════════
/// متى تحدث؟ أثناء انتظار استجابة من البيانات (Firebase/Hive)
/// الواجهة تعرض: Spinner أو Progress Bar

class TripLoading extends TripState {}

/// ═══════════════════════════════════════════════════════════════════════════
/// 🟢 TripActive - رحلة نشطة الآن
/// ═══════════════════════════════════════════════════════════════════════════
/// متى تحدث؟ بعد بدء الرحلة مباشرة
///
/// البيانات:
/// - trip: كائن الرحلة (يحتوي على جميع التفاصيل)
///   └── الموقع الحالي، المسافة المقطوعة، الزمن المنقضي، إلخ
///
/// الواجهة تعرض:
/// - الخريطة مع المسار المرسوم
/// - موقع المستخدم الحالي (Marker)
/// - الإحصائيات: الزمن، المسافة، السرعة
/// - أزرار: توقف مؤقت، إلغاء، أنهِ الرحلة

class TripActive extends TripState {
  final TripEntity trip;

  const TripActive(this.trip);

  @override
  List<Object?> get props => [trip];
}

/// ═══════════════════════════════════════════════════════════════════════════
/// ⏸️ TripPaused - رحلة موقوفة مؤقتاً
/// ═══════════════════════════════════════════════════════════════════════════
/// متى تحدث؟ عندما يضغط المستخدم "توقف مؤقت"
///
/// الفرق عن TripActive:
/// - تتبع الموقع متوقف (GPS لا يحدّث)
/// - حساب الزمن متوقف
/// - المستخدم يرى: "الرحلة موقوفة، تريد الاستئناف؟"
/// - الزر الرئيسي: "استأنف الرحلة"

class TripPaused extends TripState {
  final TripEntity trip;

  const TripPaused(this.trip);

  @override
  List<Object?> get props => [trip];
}

/// ═══════════════════════════════════════════════════════════════════════════
/// ✅ TripCompleted - الرحلة انتهت بنجاح
/// ═══════════════════════════════════════════════════════════════════════════
/// متى تحدث؟ عندما يضغط المستخدم "أنهِ الرحلة"
///
/// البيانات:
/// - trip: كائن الرحلة مع الإحصائيات النهائية
///   ├── الزمن الكلي
///   ├── المسافة الكلية
///   ├── السرعة المتوسطة
///   └── وقت البداية والنهاية
///
/// الواجهة تعرض:
/// - ملخص الرحلة (Summary Card)
/// - إحصائيات مفصلة
/// - زر: حفظ الرحلة / عودة للرئيسية

class TripCompleted extends TripState {
  final TripEntity trip;

  const TripCompleted(this.trip);

  @override
  List<Object?> get props => [trip];
}

/// ═══════════════════════════════════════════════════════════════════════════
/// 📜 TripHistoryLoaded - سجل الرحلات محمّل
/// ═══════════════════════════════════════════════════════════════════════════
/// متى تحدث؟ عندما ينتهي تحميل سجل الرحلات السابقة
///
/// البيانات:
/// - trips: قائمة بجميع الرحلات السابقة للمستخدم
///   مرتبة من الأحدث للأقدم
///
/// الواجهة تعرض:
/// - ListView مع بطاقات الرحلات
/// - كل بطاقة تحتوي:
///   ├── اسم المسار
///   ├── التاريخ
///   ├── المسافة والزمن
///   └── زر: عرض التفاصيل

class TripHistoryLoaded extends TripState {
  final List<TripEntity> trips;

  const TripHistoryLoaded(this.trips);

  @override
  List<Object?> get props => [trips];
}

/// ═══════════════════════════════════════════════════════════════════════════
/// ❌ TripError - حدث خطأ
/// ═══════════════════════════════════════════════════════════════════════════
/// متى تحدث؟ عند حدوث أي مشكلة:
/// - فشل الاتصال بـ Firebase
/// - معرّف المسار غير موجود
/// - فشل حفظ الرحلة
/// - خطأ في الأذونات (موقع)
///
/// البيانات:
/// - message: رسالة الخطأ المراد عرضها للمستخدم
///
/// الواجهة تعرض:
/// - SnackBar أو Dialog مع الخطأ
/// - زر: حاول مرة أخرى

class TripError extends TripState {
  final String message;

  const TripError(this.message);

  @override
  List<Object?> get props => [message];
}

/// ═══════════════════════════════════════════════════════════════════════════
/// ⚠️ DeviationDetected - تم اكتشاف انحراف عن المسار
/// ═══════════════════════════════════════════════════════════════════════════
/// متى تحدث؟ عندما يكتشف النظام أن المستخدم انحرف عن المسار بمسافة كبيرة
///
/// الانحراف:
/// مثل: المسار يقول "اذهب شمالاً" لكن GPS يقول "أنت تذهب شرقاً"
///
/// البيانات:
/// - trip: الرحلة الحالية
/// - deviation: بيانات الانحراف
///   ├── موقع الانحراف
///   ├── المسافة عن المسار
///   └── وقت الاكتشاف
///
/// الواجهة تعرض:
/// - تنبيه يرتجف (Shake) على الشاشة
/// - رسالة: "تحذير: انحراف عن المسار!"
/// - خيارات: تجاهل / عودة للمسار

class DeviationDetected extends TripState {
  final TripEntity trip;
  final DeviationEntity deviation;

  const DeviationDetected({
    required this.trip,
    required this.deviation,
  });

  @override
  List<Object?> get props => [trip, deviation];
}

/// ═══════════════════════════════════════════════════════════════════════════
/// 🚫 NoActiveTrip - لا توجد رحلة نشطة
/// ═══════════════════════════════════════════════════════════════════════════
/// متى تحدث؟ عند فتح التطبيق والتحقق من الرحلة النشطة
/// النتيجة: لا توجد رحلة جارية
///
/// الواجهة تعرض:
/// - رسالة: "لا توجد رحلة جارية"
/// - زر: "ابدأ رحلة جديدة"

class NoActiveTrip extends TripState {}

/// ═══════════════════════════════════════════════════════════════════════════
/// ✨ TripOperationSuccess - عملية نجحت
/// ═══════════════════════════════════════════════════════════════════════════
/// متى تحدث؟ بعد أي عملية ناجحة (حذف، تحديث، إلخ)
///
/// البيانات:
/// - message: رسالة النجاح المراد عرضها
///   مثل: "تم حفظ الرحلة بنجاح"
///
/// الواجهة تعرض:
/// - SnackBar أخضر مع الرسالة

class TripOperationSuccess extends TripState {
  final String message;
  const TripOperationSuccess(this.message);
  @override
  List<Object?> get props => [message];
}
