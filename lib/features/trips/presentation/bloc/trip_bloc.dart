import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../core/utils/logger.dart';
import '../../domain/entities/trip_entity.dart';
import '../../domain/usecases/start_trip_usecase.dart';
import '../../domain/usecases/end_trip_usecase.dart';
import '../../domain/usecases/update_trip_location_usecase.dart';
import '../../domain/usecases/get_trip_history_usecase.dart';
import '../../domain/repositories/trip_repository.dart';
import 'trip_event.dart';
import 'trip_state.dart';

/// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
/// ๐ฃ๏ธ TripBloc - ุฅุฏุงุฑุฉ ุญุงูุฉ ุงูุฑุญูุงุช (Presentation Layer)
/// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
///
/// ุงููุฏู ูู ูุฐุง ุงูููู:
/// ูุฏูุฑ ุฏูุฑุฉ ุญูุงุฉ ุงูุฑุญูุงุช ูู ุงูุจุฏุงูุฉ ุฅูู ุงูููุงูุฉ
/// 
/// ูุณุคูููุงุช TripBloc:
/// 1. ุจุฏุก ุฑุญูุฉ ุฌุฏูุฏุฉ ุนูู ูุณุงุฑ ูุญุฏุฏ
/// 2. ุชุญุฏูุซ ูููุน ุงูุฑุญูุฉ ุฃุซูุงุก ุงูุญุฑูุฉ (GPS updates)
/// 3. ุฅููุงู ุงูุฑุญูุฉ ูุคูุชุงู (Pause - ููุฑุงุญุฉ)
/// 4. ุงุณุชุฆูุงู ุงูุฑุญูุฉ (Resume - ุงูุนูุฏุฉ ููุญุฑูุฉ)
/// 5. ุฅููุงุก ุงูุฑุญูุฉ (End - ุงููุตูู ูููุฌูุฉ)
/// 6. ุฅูุบุงุก ุงูุฑุญูุฉ (Cancel - ุฅูุบุงุก ููุงุฌุฆ)
/// 7. ุชุญููู ุณุฌู ุงูุฑุญูุงุช ุงูุณุงุจูุฉ (History)
/// 8. ุชุญููู ุงูุฑุญูุฉ ุงููุดุทุฉ ุงูุญุงููุฉ
///
/// States (ุงูุญุงูุงุช):
/// - TripInitial: ุงูุจุฏุงูุฉ (ูุง ุชูุฌุฏ ุฑุญูุฉ)
/// - TripLoading: ุฌุงุฑู ุงูุชุญููู
/// - TripActive: ุฑุญูุฉ ูุดุทุฉ ุญุงููุงู
/// - TripPaused: ุฑุญูุฉ ูููููุฉ ูุคูุชุงู
/// - TripCompleted: ุฑุญูุฉ ุงูุชูุช
/// - TripHistoryLoaded: ุชุญููู ุงูุณุฌู
/// - NoActiveTrip: ูุง ุชูุฌุฏ ุฑุญูุฉ ูุดุทุฉ
/// - DeviationDetected: ุงูุชุดุงู ุงูุญุฑุงู ุนู ุงููุณุงุฑ
/// - TripError: ุญุฏุซ ุฎุทุฃ
///
/// ูุซุงู ุนููู - ุฏูุฑุฉ ุญูุงุฉ ุงูุฑุญูุฉ:
/// ```
/// 1. ุงููุณุชุฎุฏู ูุฎุชุงุฑ ูุณุงุฑ ููุถุบุท "ุงุจุฏุฃ ุงูุฑุญูุฉ"
///    โ add(StartTrip(...))
///    
/// 2. TripBloc ูุณุชุฏุนู startTripUseCase
///    โ useCase ูุชุญูู: ูุง ุชูุฌุฏ ุฑุญูุฉ ูุดุทุฉ + ุงููุณุงุฑ ููุฌูุฏ
///    โ emit(TripActive(trip))
///    
/// 3. ุฃุซูุงุก ุงูุญุฑูุฉุ GPS ูุญุฏุซ ุงููููุน ูู ุซุงููุฉ
///    โ add(UpdateLocation(...))
///    โ useCase ููุชุดู ุงูุงูุญุฑุงูุ
///    โ emit(TripActive) ุฃู emit(DeviationDetected)
///    
/// 4. ุงููุณุชุฎุฏู ูุฑูุฏ ุงูุฑุงุญุฉ
///    โ add(PauseTrip(...))
///    โ emit(TripPaused(trip))
///    
/// 5. ูุตู ุงููุฌูุฉ
///    โ add(EndTrip(...))
///    โ emit(TripCompleted(trip))
///    
/// 6. ุงูุฑุญูุฉ ูุญููุธุฉ ูู Hive/Firebase
///    โ ูููู ุนุฑุถูุง ูุงุญูุงู ูู Trip History
/// ```

class TripBloc extends Bloc<TripEvent, TripState> {
  /// ๐ ุงูุงุนุชูุงุฏูุงุช (Use Cases ู Repository)
  final StartTripUseCase startTripUseCase;           /// ๐ ุจุฏุก ุฑุญูุฉ
  final EndTripUseCase endTripUseCase;               /// ๐ ุฅููุงุก ุฑุญูุฉ
  final UpdateTripLocationUseCase updateTripLocationUseCase; /// ๐ ุชุญุฏูุซ ุงููููุน
  final GetTripHistoryUseCase getTripHistoryUseCase; /// ๐ ุณุฌู ุงูุฑุญูุงุช
  final TripRepository tripRepository;               /// ๐พ ุงููุตูู ุงููุจุงุดุฑ ููู Repository

  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  /// Constructor - ุชููุฆุฉ TripBloc
  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  /// 
  /// super(TripInitial())
  ///   โ ุงูุญุงูุฉ ุงูุฃูููุฉ: "ูู ุชุจุฏุฃ ุฃู ุฑุญูุฉ"
  /// 
  /// on<StartTrip>(_onStartTrip)
  ///   โ ุฑุจุท ุญุฏุซ ุจุฏุก ุงูุฑุญูุฉ ุจูุนุงูุฌู
  /// 
  /// ูู ุญุฏุซ ููุซู "ุฅุฌุฑุงุก ููุนูู ุงููุณุชุฎุฏู"

  TripBloc({
    required this.startTripUseCase,
    required this.endTripUseCase,
    required this.updateTripLocationUseCase,
    required this.getTripHistoryUseCase,
    required this.tripRepository,
  }) : super(TripInitial()) {
    /// ุฑุจุท ุงูุฃุญุฏุงุซ ุจูุนุงูุฌุงุชูุง
    on<StartTrip>(_onStartTrip);         /// ุงููุณุชุฎุฏู ุถุบุท "ุงุจุฏุฃ ุงูุฑุญูุฉ"
    on<EndTrip>(_onEndTrip);             /// ุงููุณุชุฎุฏู ุถุบุท "ุฃููู ุงูุฑุญูุฉ"
    on<PauseTrip>(_onPauseTrip);         /// ุงููุณุชุฎุฏู ุถุบุท "ุชููู ูุคูุช"
    on<ResumeTrip>(_onResumeTrip);       /// ุงููุณุชุฎุฏู ุถุบุท "ุงุณุชุฃูู ุงูุฑุญูุฉ"
    on<CancelTrip>(_onCancelTrip);       /// ุงููุณุชุฎุฏู ุถุบุท "ุฅูุบุงุก"
    on<UpdateLocation>(_onUpdateLocation); /// GPS ุญุฏูุซ ุงููููุน
    on<LoadTripHistory>(_onLoadTripHistory); /// ุงููุณุชุฎุฏู ูุชุญ "ุงูุณุฌู"
    on<LoadActiveTrip>(_onLoadActiveTrip);   /// ุชุญููู ุงูุฑุญูุฉ ุงููุดุทุฉ ุนูุฏ ุงูุจุฏุก
  }

  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  /// ๐ ูุนุงูุฌ ุงูุญุฏุซ: ุจุฏุก ุฑุญูุฉ ุฌุฏูุฏุฉ (_onStartTrip)
  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  ///
  /// ูุชู ูุชู ุงุณุชุฏุนุงุก ูุฐู ุงูุฏุงูุฉุ
  /// ุงููุณุชุฎุฏู ุงุฎุชุงุฑ ูุณุงุฑ ูู ุงููุงุฆูุฉ ูุถุบุท ุนูู "ุงุจุฏุฃ ุงูุฑุญูุฉ"
  ///
  /// ูุนุงููุงุช ุงูุญุฏุซ:
  /// - routeId: ูุนุฑู ุงููุณุงุฑ
  /// - userId: ูุนุฑู ุงููุณุชุฎุฏู
  /// - startLocation: ูููุน ุงูุจุฏุงูุฉ (latitude, longitude)
  ///
  /// ุฎุทูุงุช ุงูุจุฏุก:
  /// 1๏ธโฃ ุฃุฑุณู ุญุงูุฉ "ุฌุงุฑู ุงูุชุญููู"
  /// 2๏ธโฃ ุงุณุชุฏุนู startTripUseCase ููุชุญูู:
  ///    - ูู ููุฌุฏ ุฑุญูุฉ ูุดุทุฉ ุจุงููุนูุ (ูุง ูููู ุฑุญูุชุงู ูุนุงู)
  ///    - ูู ุงููุณุงุฑ ููุฌูุฏุ
  ///    - ูู ุงูุจูุงูุงุช ุตุญูุญุฉุ
  /// 3๏ธโฃ ุฅุฐุง ูู ุดูุก ุชูุงู:
  ///    - ุฃูุดุฆ ุฑุญูุฉ ุฌุฏูุฏุฉ
  ///    - ุงุญูุธูุง ูู Hive (ููุฑุงู)
  ///    - ุฃุฑุณู ุญุงูุฉ: TripActive
  ///    - ุงููุงุฌูุฉ ุณุชุนุฑุถ ุดุงุดุฉ ุงูุฑุญูุฉ ุงููุดุทุฉ
  /// 4๏ธโฃ ุฅุฐุง ุญุฏุซ ุฎุทุฃ:
  ///    - ุฃุฑุณู ุญุงูุฉ: TripError ูุน ุฑุณุงูุฉ
  ///    - ุงููุงุฌูุฉ ุณุชุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ

  Future<void> _onStartTrip(StartTrip event, Emitter<TripState> emit) async {
    /// 1๏ธโฃ ุฃุฑุณู ุญุงูุฉ ุชุญููู
    emit(TripLoading());
    AppLogger.info('[TripBloc] ๐ ุฌุงุฑู ุจุฏุก ุฑุญูุฉ ุฌุฏูุฏุฉ...', name: 'TripBloc');

    /// 2๏ธโฃ ุงุณุชุฏุนู startTripUseCase
    /// startTripUseCase ูู object ูุญุชูู ุนูู ููุทู ุจุฏุก ุงูุฑุญูุฉ
    /// ููุฑุฑ: routeId, userId, ูููุน ุงูุจุฏุงูุฉ
    final result = await startTripUseCase(
      routeId: event.routeId,
      userId: event.userId,
      currentLocation: event.startLocation,
    );

    /// 3๏ธโฃ ูุนุงูุฌุฉ ุงููุชูุฌุฉ
    result.fold(
      /// โ ูุดู: ูุง ุชูุฌุฏ ุฑุญูุฉ ูุดุทุฉ ุฃู ุฎุทุฃ ุขุฎุฑ
      /// (ูุฐุง ูุนูู: ูฺฉู ุจุฏุก ุงูุฑุญูุฉ ูุฃูู ูุง ุชูุฌุฏ ุฑุญูุฉ ุฃุฎุฑู)
      (failure) {
        AppLogger.error('[TripBloc] โ ูุดู ุจุฏุก ุงูุฑุญูุฉ: ${failure.message}', name: 'TripBloc');
        
        /// ุฃุฑุณู ุญุงูุฉ ุฎุทุฃ ูุน ุงูุฑุณุงูุฉ
        /// ุงููุงุฌูุฉ ุณุชุนุฑุถ SnackBar ุจุงูุฎุทุฃ
        emit(TripError(failure.message));
      },
      
      /// โ ูุฌุงุญ: ุงูุฑุญูุฉ ุจุฏุฃุช ุจูุฌุงุญ
      (trip) {
        AppLogger.success('[TripBloc] โ ุชู ุจุฏุก ุงูุฑุญูุฉ ุจูุฌุงุญ (ID: ${trip.id})', name: 'TripBloc');
        
        /// ุฃุฑุณู ุญุงูุฉ: ุงูุฑุญูุฉ ูุดุทุฉ
        /// ุงููุงุฌูุฉ ุณุชุนุฑุถ:
        /// - ุงูุฎุฑูุทุฉ ูุน ุงููุณุงุฑ ุงููุฑุณูู
        /// - ูููุน ุงููุณุชุฎุฏู ุงูุญุงูู
        /// - ุงูุฒูู ุงููููุถู
        /// - ุงููุณุงูุฉ ุงูููุทูุนุฉ
        emit(TripActive(trip));
      },
    );
  }

  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  /// ๐ ูุนุงูุฌ ุงูุญุฏุซ: ุฅููุงุก ุงูุฑุญูุฉ (_onEndTrip)
  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  ///
  /// ูุชู ูุชู ุงุณุชุฏุนุงุก ูุฐู ุงูุฏุงูุฉุ
  /// ุงููุณุชุฎุฏู ูุตู ูููุฌูุฉ ูุถุบุท ุนูู "ุฃููู ุงูุฑุญูุฉ"
  ///
  /// ูุง ูุญุฏุซ:
  /// 1๏ธโฃ ุฃุฑุณู ุญุงูุฉ "ุฌุงุฑู ุงูุฅููุงุก"
  /// 2๏ธโฃ ุงุณุชุฏุนู endTripUseCase
  ///    - ูุญุณุจ ุฅุฌูุงูู ุงูุฒูู
  ///    - ูุญุณุจ ุฅุฌูุงูู ุงููุณุงูุฉ
  ///    - ูุญุณุจ ุงูุณุฑุนุฉ ุงููุชูุณุทุฉ
  ///    - ูุญูุธ ุงูุฑุญูุฉ ูู Hive ู Firebase
  /// 3๏ธโฃ ุฃุฑุณู ุญุงูุฉ: TripCompleted
  /// 4๏ธโฃ ุงููุงุฌูุฉ ุชุนุฑุถ:
  ///    - ููุฎุต ุงูุฑุญูุฉ (ุงููุณุงูุฉุ ุงูุฒููุ ุงูุณุฑุนุฉ)
  ///    - ุฎูุงุฑ: ุนูุฏุฉ ููุตูุญุฉ ุงูุฑุฆูุณูุฉ

  Future<void> _onEndTrip(EndTrip event, Emitter<TripState> emit) async {
    emit(TripLoading());
    AppLogger.info('[TripBloc] ๐ ุฌุงุฑู ุฅููุงุก ุงูุฑุญูุฉ...', name: 'TripBloc');

    /// ุงุณุชุฏุนุงุก endTripUseCase ูุน ูุนุฑู ุงูุฑุญูุฉ ููููุน ุงูููุงูุฉ
    final result = await endTripUseCase(
      tripId: event.tripId,
      endLocation: event.endLocation,
    );

    result.fold(
      (failure) {
        AppLogger.error('[TripBloc] โ ูุดู ุฅููุงุก ุงูุฑุญูุฉ: ${failure.message}', name: 'TripBloc');
        emit(TripError(failure.message));
      },
      (trip) {
        AppLogger.success('[TripBloc] โ ุชู ุฅููุงุก ุงูุฑุญูุฉ ุจูุฌุงุญ', name: 'TripBloc');
        
        /// ุฃุฑุณู ุญุงูุฉ: ุงูุฑุญูุฉ ุงูุชูุช
        /// ุงููุงุฌูุฉ ุณุชุนุฑุถ ููุฎุต ุงูุฑุญูุฉ
        emit(TripCompleted(trip));
      },
    );
  }

  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  /// โธ๏ธ ูุนุงูุฌ ุงูุญุฏุซ: ุฅููุงู ุงูุฑุญูุฉ ูุคูุชุงู (_onPauseTrip)
  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  ///
  /// ูุชู ูุชู ุงุณุชุฏุนุงุก ูุฐู ุงูุฏุงูุฉุ
  /// ุงููุณุชุฎุฏู ูุฑูุฏ ุงูุฑุงุญุฉ ุฃู ุงูุณูุงุญ ููุฑุงูุจูู ุจุงููุฒูู
  ///
  /// ูุง ูุญุฏุซ:
  /// - ุชููู ุชุชุจุน ุงููููุน ูุคูุชุงู
  /// - ุชููู ุญุณุงุจ ุงูุฒูู
  /// - ุงููุงุฌูุฉ ุชุนุฑุถ ุฒุฑ "ุงุณุชุฃูู ุงูุฑุญูุฉ"

  Future<void> _onPauseTrip(PauseTrip event, Emitter<TripState> emit) async {
    /// ุงุณุชุฏุนุงุก Repository ูุจุงุดุฑุฉ (ุจุฏู Use Case)
    /// ุงูุณุจุจ: ุนูููุฉ ุจุณูุทุฉุ ูุง ุชุญุชุงุฌ ููุทู ูุนูุฏ
    final result = await tripRepository.pauseTrip(event.tripId);

    result.fold(
      (failure) {
        AppLogger.error('[TripBloc] โ ูุดู ุฅููุงู ุงูุฑุญูุฉ: ${failure.message}', name: 'TripBloc');
        emit(TripError(failure.message));
      },
      (trip) {
        AppLogger.success('[TripBloc] โ ุชู ุฅููุงู ุงูุฑุญูุฉ ูุคูุชุงู', name: 'TripBloc');
        /// ุฃุฑุณู ุญุงูุฉ: ุงูุฑุญูุฉ ูููููุฉ
        emit(TripPaused(trip));
      },
    );
  }

  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  /// โถ๏ธ ูุนุงูุฌ ุงูุญุฏุซ: ุงุณุชุฆูุงู ุงูุฑุญูุฉ (_onResumeTrip)
  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  ///
  /// ูุชู ูุชู ุงุณุชุฏุนุงุก ูุฐู ุงูุฏุงูุฉุ
  /// ุงููุณุชุฎุฏู ุงูุชูู ูู ุงูุฑุงุญุฉ ูุถุบุท "ุงุณุชุฃูู ุงูุฑุญูุฉ"
  ///
  /// ูุง ูุญุฏุซ:
  /// - ุนูุฏุฉ ุชุชุจุน ุงููููุน
  /// - ุงุณุชุฆูุงู ุญุณุงุจ ุงูุฒูู
  /// - ุงููุงุฌูุฉ ุชุนุฑุถ ุดุงุดุฉ ุงูุฑุญูุฉ ุงููุดุทุฉ ูุฑุฉ ุฃุฎุฑู

  Future<void> _onResumeTrip(ResumeTrip event, Emitter<TripState> emit) async {
    /// ุงุณุชุฏุนุงุก Repository ูุงุณุชุฆูุงู ุงูุฑุญูุฉ
    final result = await tripRepository.resumeTrip(event.tripId);

    result.fold(
      (failure) {
        AppLogger.error('[TripBloc] โ ูุดู ุงุณุชุฆูุงู ุงูุฑุญูุฉ: ${failure.message}', name: 'TripBloc');
        emit(TripError(failure.message));
      },
      (trip) {
        AppLogger.success('[TripBloc] โ ุชู ุงุณุชุฆูุงู ุงูุฑุญูุฉ ุจูุฌุงุญ', name: 'TripBloc');
        /// ุฃุฑุณู ุญุงูุฉ: ุงูุฑุญูุฉ ูุดุทุฉ ูุฑุฉ ุฃุฎุฑู
        emit(TripActive(trip));
      },
    );
  }

  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  /// โ ูุนุงูุฌ ุงูุญุฏุซ: ุฅูุบุงุก ุงูุฑุญูุฉ (_onCancelTrip)
  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  ///
  /// ูุชู ูุชู ุงุณุชุฏุนุงุก ูุฐู ุงูุฏุงูุฉุ
  /// ุงููุณุชุฎุฏู ุฃุฑุงุฏ ุฅูุบุงุก ุงูุฑุญูุฉ (ุทุงุฑุฆ ุฃู ุชุบููุฑ ุงูุฎุทุท)
  ///
  /// ูุง ูุญุฏุซ:
  /// - ุญุฐู ุงูุฑุญูุฉ ุบูุฑ ุงููุญููุธุฉ
  /// - ุงูุนูุฏุฉ ููุญุงูุฉ ุงูุฃูููุฉ (TripInitial)
  /// - ุงููุงุฌูุฉ ุชุนุฑุถ: "ุชู ุฅูุบุงุก ุงูุฑุญูุฉ"

  Future<void> _onCancelTrip(CancelTrip event, Emitter<TripState> emit) async {
    /// ุงุณุชุฏุนุงุก Repository ูุฅูุบุงุก ุงูุฑุญูุฉ
    final result = await tripRepository.cancelTrip(event.tripId);

    result.fold(
      (failure) => emit(TripError(failure.message)),
      /// (_) = ignoring the result
      (_) {
        AppLogger.info('[TripBloc] ุชู ุฅูุบุงุก ุงูุฑุญูุฉ', name: 'TripBloc');
        /// ุงูุนูุฏุฉ ููุญุงูุฉ ุงูุฃูููุฉ
        emit(TripInitial());
      },
    );
  }

  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  /// ๐ ูุนุงูุฌ ุงูุญุฏุซ: ุชุญุฏูุซ ูููุน ุงูุฑุญูุฉ (_onUpdateLocation)
  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  ///
  /// ูุชู ูุชู ุงุณุชุฏุนุงุก ูุฐู ุงูุฏุงูุฉุ
  /// GPS ูุญุฏูุซ ุงููููุน ุงูุญุงูู (ูู ุซุงููุฉ ุชูุฑูุจุงู)
  ///
  /// ูุนุงููุงุช ุงูุญุฏุซ:
  /// - tripId: ูุนุฑู ุงูุฑุญูุฉ
  /// - location: ุงููููุน ุงูุฌุฏูุฏ (GPS)
  /// - expectedLocation: ุงููููุน ุงููุชููุน (ุนูู ุงููุณุงุฑ)
  ///
  /// ูุง ูุญุฏุซ:
  /// 1๏ธโฃ ุงุณุชุฏุนู updateTripLocationUseCase
  /// 2๏ธโฃ useCase ูุญุณุจ:
  ///    - ุงููุณุงูุฉ ุงูููุทูุนุฉ ุงูุฌุฏูุฏุฉ
  ///    - ุงูุงูุญุฑุงู ุนู ุงููุณุงุฑ
  /// 3๏ธโฃ ุฅุฐุง ุญุฏุซ ุงูุญุฑุงู ูุจูุฑ:
  ///    - emit(DeviationDetected) โ ุนุฑุถ ุชุญุฐูุฑ
  /// 4๏ธโฃ ุฅุฐุง ูู ุดูุก ุทุจูุนู:
  ///    - emit(TripActive) ูุน ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
  ///    - ุงููุงุฌูุฉ ุชุญุฏุซ ุงูุฎุฑูุทุฉ ูุงูุฅุญุตุงุฆูุงุช
  ///
  /// ููุงุญุธุฉ ูููุฉ:
  /// ูุฐู ุงูุฏุงูุฉ ุชูุณุชุฏุนู ูุฆุงุช ุงููุฑุงุช ุฃุซูุงุก ุงูุฑุญูุฉ!
  /// ูุฐุง ูุญุชุงุฌ ุฃู ุชููู ุณุฑูุนุฉ ุฌุฏุงู

  Future<void> _onUpdateLocation(UpdateLocation event, Emitter<TripState> emit) async {
    /// ุงุณุชุฏุนุงุก useCase ูุชุญุฏูุซ ุงููููุน
    final result = await updateTripLocationUseCase(
      tripId: event.tripId,
      newLocation: event.location,
      expectedLocation: event.expectedLocation,
    );

    result.fold(
      (failure) {
        /// ุฅุฐุง ุญุฏุซ ุฎุทุฃุ ูุณุฌู ููุท (ูุง ูุจุทุฆ ุงูุฑุญูุฉ)
        AppLogger.error('[TripBloc] ูุดู ุชุญุฏูุซ ุงููููุน', name: 'TripBloc');
      },
      (trip) {
        /// ุงูุชุญูู: ูู ุญุฏุซ ุงูุญุฑุงู ุนู ุงููุณุงุฑุ
        if (trip.deviations.isNotEmpty) {
          /// ููุงู ุงูุญุฑุงูุงุช
          final lastDeviation = trip.deviations.last;
          
          /// ูู ุชู ุฅุฑุณุงู ุชูุจูู ุนู ูุฐุง ุงูุงูุญุฑุงูุ
          if (!lastDeviation.wasAlertSent) {
            /// ูู ูุชู ุงูุฅุฑุณุงูุ ูุฃุฑุณู ุงูุขู
            AppLogger.warning('[TripBloc] โ๏ธ ุชู ุงูุชุดุงู ุงูุญุฑุงู ุนู ุงููุณุงุฑ!', name: 'TripBloc');
            
            /// emit ุญุงูุฉ ุฎุงุตุฉ: Deviation Detected
            /// AlertBloc ุณูุณุชูุน ููุฐู ุงูุญุงูุฉ ูุณูุฑุณู ุชูุจูู
            emit(DeviationDetected(trip: trip, deviation: lastDeviation));
            return;
          }
        }
        
        /// ูุง ููุฌุฏ ุงูุญุฑุงู ุฌุฏูุฏุ ุญุฏูุซ ุงููุงุฌูุฉ ุจุงููููุน ุงูุฌุฏูุฏ
        if (trip.status == TripStatus.active) {
          emit(TripActive(trip));
        } else if (trip.status == TripStatus.paused) {
          emit(TripPaused(trip));
        }
      },
    );
  }

  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  /// ๐ ูุนุงูุฌ ุงูุญุฏุซ: ุชุญููู ุณุฌู ุงูุฑุญูุงุช (_onLoadTripHistory)
  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  ///
  /// ูุชู ูุชู ุงุณุชุฏุนุงุก ูุฐู ุงูุฏุงูุฉุ
  /// ุงููุณุชุฎุฏู ูุชุญ ุตูุญุฉ "ุงูุณุฌู" ููุดูู ุฑุญูุงุชู ุงูุณุงุจูุฉ
  ///
  /// ูุนุงููุงุช ุงูุญุฏุซ:
  /// - userId: ูุนุฑู ุงููุณุชุฎุฏู
  /// - limit: ุนุฏุฏ ุงูุฑุญูุงุช ุงููุทููุจุฉ (ูุซู 20 ุฑุญูุฉ ุฃุฎูุฑุฉ)
  /// - from ู to: ูุทุงู ุงูุชุงุฑูุฎ (ุงุฎุชูุงุฑู)
  ///
  /// ูุง ูุญุฏุซ:
  /// 1๏ธโฃ ุงุณุชุฏุนู getTripHistoryUseCase
  /// 2๏ธโฃ useCase ูุฌูุจ ูู Hive/Firebase:
  ///    - ุงูุฑุญูุงุช ุงููุญููุธุฉ
  ///    - ูุฑุชุจุฉ ูู ุงูุฃุญุฏุซ ููุฃูุฏู
  /// 3๏ธโฃ emit(TripHistoryLoaded) ูุน ูุงุฆูุฉ ุงูุฑุญูุงุช
  /// 4๏ธโฃ ุงููุงุฌูุฉ ุชุนุฑุถ ุงูุฑุญูุงุช ูู ListView

  Future<void> _onLoadTripHistory(LoadTripHistory event, Emitter<TripState> emit) async {
    /// ููุท ุฃุฑุณู TripLoading ุฅุฐุง ูู ููู ูุนุฑุถ ุงูุณุฌู ุจุงููุนู
    /// (ูุชุฌูุจ "ูููุถ" ุงูู UI ุนูุฏ ุงูุชุญุฏูุซ)
    if (state is! TripHistoryLoaded) {
      emit(TripLoading());
    }

    /// ุงุณุชุฏุนุงุก useCase ูุฌูุจ ุณุฌู ุงูุฑุญูุงุช
    final result = await getTripHistoryUseCase(
      userId: event.userId,
      limit: event.limit,
      from: event.from,
      to: event.to,
    );

    result.fold(
      (failure) => emit(TripError(failure.message)),
      (trips) {
        AppLogger.info('[TripBloc] ุชู ุชุญููู ${trips.length} ุฑุญูุฉ', name: 'TripBloc');
        /// ุฃุฑุณู ุญุงูุฉ: ุงูุณุฌู ูุญููู ูุน ูุงุฆูุฉ ุงูุฑุญูุงุช
        emit(TripHistoryLoaded(trips));
      },
    );
  }

  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  /// ๐ ูุนุงูุฌ ุงูุญุฏุซ: ุชุญููู ุงูุฑุญูุฉ ุงููุดุทุฉ ุงูุญุงููุฉ (_onLoadActiveTrip)
  /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  ///
  /// ูุชู ูุชู ุงุณุชุฏุนุงุก ูุฐู ุงูุฏุงูุฉุ
  /// ุนูุฏ ุจุฏุก ุงูุชุทุจูู ุฃู ุฅุนุงุฏุฉ ุชุญููู ุงููุงุฌูุฉ
  /// (ููุชุญูู: ูู ููุงู ุฑุญูุฉ ูุดุทุฉ ูู ูุจูุ)
  ///
  /// ุงูุณููุงุฑูููุงุช:
  /// 1๏ธโฃ ูุง ุชูุฌุฏ ุฑุญูุฉ ูุดุทุฉ
  ///    โ emit(NoActiveTrip)
  ///    โ ุงููุงุฌูุฉ ุชุนุฑุถ: "ูุง ุชูุฌุฏ ุฑุญูุฉ ุญุงููุงู"
  /// 
  /// 2๏ธโฃ ุชูุฌุฏ ุฑุญูุฉ ูุดุทุฉ
  ///    โ emit(TripActive)
  ///    โ ุงููุงุฌูุฉ ุชุนุฑุถ ุดุงุดุฉ ุงูุฑุญูุฉ
  /// 
  /// 3๏ธโฃ ุชูุฌุฏ ุฑุญูุฉ ูููููุฉ
  ///    โ emit(TripPaused)
  ///    โ ุงููุงุฌูุฉ ุชุนุฑุถ: "ุฑุญูุฉ ูููููุฉุ ุชุฑูุฏ ุงูุงุณุชุฆูุงูุ"

  Future<void> _onLoadActiveTrip(LoadActiveTrip event, Emitter<TripState> emit) async {
    /// ูุง ูุบูุฑ ููู Loading ุฅุฐุง ูุงูุช ููุงู ุฑุญูุฉ ูุดุทุฉ ุจุงููุนู
    /// (ุชุฌูุจ ุงููููุถ)
    if (state is! TripActive && state is! TripPaused) {
      emit(TripLoading());
    }

    /// ุงุณุชุฏุนุงุก Repository ููุญุตูู ุนูู ุงูุฑุญูุฉ ุงููุดุทุฉ
    final result = await tripRepository.getActiveTrip(event.userId);

    result.fold(
      (failure) => emit(TripError(failure.message)),
      (trip) {
        if (trip == null) {
          /// ูุง ุชูุฌุฏ ุฑุญูุฉ ูุดุทุฉ
          AppLogger.info('[TripBloc] ูุง ุชูุฌุฏ ุฑุญูุฉ ูุดุทุฉ', name: 'TripBloc');
          emit(NoActiveTrip());
        } else if (trip.status == TripStatus.paused) {
          /// ุชูุฌุฏ ุฑุญูุฉ ูููููุฉ
          emit(TripPaused(trip));
        } else {
          /// ุชูุฌุฏ ุฑุญูุฉ ูุดุทุฉ
          AppLogger.info('[TripBloc] ุชุญููู ุงูุฑุญูุฉ ุงููุดุทุฉ: ${trip.id}', name: 'TripBloc');
          emit(TripActive(trip));
        }
      },
    );
  }
}
