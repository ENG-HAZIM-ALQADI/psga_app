import 'dart:async';
import 'package:flutter/foundation.dart';
import 'package:firebase_auth/firebase_auth.dart';
import '../../../config/app_config.dart';
import '../connectivity/connectivity_service.dart';
import 'sync_item.dart';
import 'sync_service.dart';

/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/// ğŸ”„ SyncManager - Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø°ÙƒÙŠ (Singleton)
/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
///
/// Ø§Ù„Ù‡Ø¯Ù Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù (Core/Services Layer):
/// ÙŠØ¯ÙŠØ± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ø°ÙƒÙŠØ© Ø¨ÙŠÙ† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ (Hive) 
/// ÙˆØ§Ù„Ø³Ø­Ø§Ø¨ÙŠ (Firebase) Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø© ÙˆÙØ¹Ø§Ù„Ø©
/// 
/// Ù…Ø¨Ø¯Ø£ Ø§Ù„ØªØµÙ…ÙŠÙ…: Offline-First Architecture
/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
///
/// Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ©:
/// - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª â†’ ÙŠÙ†ØªØ¸Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª â†’ Ø¨Ø·Ø¡ Ø¹Ø§Ù…
/// - Ù„Ø§ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª â†’ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!
///
/// Ø§Ù„Ø­Ù„ (Offline-First):
/// 1ï¸âƒ£ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
///    â†’ ØªÙØ­ÙØ¸ ÙÙˆØ±Ø§Ù‹ ÙÙŠ Hive (Ù‚Ø§Ø¹Ø¯Ø© Ù…Ø­Ù„ÙŠØ© Ø³Ø±ÙŠØ¹Ø© Ø¬Ø¯Ø§Ù‹)
///    â†’ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªØ­Ø¯Ù‘Ø« ÙÙˆØ±Ø§Ù‹ (Ø³Ø±Ø¹Ø© Ø¨Ø±ÙŠÙ‚!)
/// 
/// 2ï¸âƒ£ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¥Ù†ØªØ±Ù†Øª
///    â†’ Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ© Ù…Ø¹ Firebase (Ø®Ù„ÙÙŠØ© Ù‡Ø§Ø¯Ø¦Ø©)
/// 
/// 3ï¸âƒ£ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¥Ù†ØªØ±Ù†Øª
///    â†’ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¨Ù‚Ù‰ Ø¢Ù…Ù†Ø© ÙÙŠ Hive
///    â†’ SyncManager ÙŠÙ†ØªØ¸Ø± Ø¹ÙˆØ¯Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
/// 
/// 4ï¸âƒ£ Ø¹Ù†Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
///    â†’ Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ÙÙˆØ±ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
///    â†’ ConflictResolver Ø­Ù„ Ø£ÙŠ ØªØ¶Ø§Ø±Ø¨ Ø¨ÙŠÙ† Local Ùˆ Remote
///
/// Ø§Ù„ÙÙˆØ§Ø¦Ø¯:
/// âœ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª (ØªØ¬Ø±Ø¨Ø© Ø³Ù„Ø³Ø©)
/// âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§ ØªÙÙÙ‚Ø¯ Ø£Ø¨Ø¯Ø§Ù‹ (Ø¢Ù…Ø§Ù† Ø¹Ø§Ù„ÙŠ)
/// âœ… Ø§Ù„Ø³Ø±Ø¹Ø© Ø£ÙˆÙ„Ø§Ù‹ (Hive Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹)
/// âœ… Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© (Ø¨Ø¯ÙˆÙ† ØªØ¯Ø®Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
/// âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ§Ù„ØªØ¶Ø§Ø±Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
///
/// Ù…Ø«Ø§Ù„ Ø¹Ù…Ù„ÙŠ:
/// ```
/// Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø­Ù„Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª
/// 
/// 1. Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø©"
/// 2. TripBloc ÙŠØ³ØªØ¯Ø¹ÙŠ startTripUseCase
/// 3. startTripUseCase ÙŠØ­ÙØ¸ ÙÙŠ Hive ÙÙˆØ±Ø§Ù‹
///    â†’ emit(TripActive) - Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªØ­Ø¯Ø« ÙÙˆØ±Ø§Ù‹ âš¡
/// 4. SyncManager ÙŠÙƒØªØ´Ù Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
///    â†’ ÙŠØ­Ø§ÙˆÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Firebase
///    â†’ Ù„Ø§ Ø§ØªØµØ§Ù„ØŸ Ù†Ø¶Ø¹ Ø§Ù„Ø±Ø­Ù„Ø© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
/// 5. Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙØªØ­ WiFi
/// 6. SyncManager ÙŠÙƒØªØ´Ù Ø¹ÙˆØ¯Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
///    â†’ ÙŠØ²Ø§Ù…Ù† Ø§Ù„Ø±Ø­Ù„Ø© ÙÙˆØ±Ø§Ù‹
///    â†’ emit(SyncStatus) - Ø¥Ø®Ø·Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
/// ```
///
/// Singleton Pattern:
/// Ù†Ø³Ø®Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø·ÙˆØ§Ù„ Ø¹Ù…Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
/// Ù„Ø§ Ù†Ø±ÙŠØ¯ Ø¹Ø¯Ø© instances ØªØªÙ†Ø§ÙØ³ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©!

class SyncManager {
  /// Ù…Ù†Ø¹ Ø¥Ù†Ø´Ø§Ø¡ instances Ù…Ù† Ø§Ù„Ø®Ø§Ø±Ø¬
  SyncManager._();

  /// Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙˆØ­ÙŠØ¯Ø© Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù€ Class (Singleton)
  static final SyncManager _instance = SyncManager._();
  static SyncManager get instance => _instance;

  /// ğŸ”— Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (Dependencies)
  /// SyncService: ÙŠØ¯ÙŠØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙˆØ§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
  /// ConnectivityService: ÙŠØ±Ø§Ù‚Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
  final SyncService _syncService = SyncService.instance;
  final ConnectivityService _connectivityService = ConnectivityService.instance;

  /// ğŸ“Š Ù…ØªØºÙŠØ±Ø§Øª ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø§Ù„Ø©
  bool _isSyncing = false;              /// Ù‡Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ØªØ¹Ù…Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹ØŸ
  Timer? _syncTimer;                    /// Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠØ©
  Duration _syncInterval = const Duration(minutes: AppConfig.syncIntervalMinutes);
  /// Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© (Ù…Ø«Ù„: ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚ØŒ Ø§Ø­Ø³Ø¨ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¹Ù†Ø§ØµØ± Ù…Ø¹Ù„Ù‚Ø©)

  /// ğŸ”” Stream Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
  /// Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªØ³ØªÙ…Ø¹ Ù„Ù‡Ø°Ø§ Stream Ù„ØªØ¹Ø±Ù:
  /// - Ù‡Ù„ Ø¬Ø§Ø±ÙŠØ© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©ØŸ
  /// - ÙƒÙ… Ø¹Ù†ØµØ± Ù…Ø¹Ù„Ù‚ØŸ
  /// - Ø­Ø¯Ø« Ø®Ø·Ø£ØŸ
  final StreamController<SyncStatus> _syncStatusController =
  StreamController<SyncStatus>.broadcast();

  /// ğŸ“¤ Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ Ù…Ù† Ø§Ù„Ø®Ø§Ø±Ø¬)
  /// Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ£Ø®Ø° Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯ ÙˆØªØ­Ø§ÙˆÙ„ Ù…Ø²Ø§Ù…Ù†ØªÙ‡ Ù…Ø¹ Firebase
  /// ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ Ù…Ù† main.dart Ø£Ùˆ Ù…Ù† BLoCs
  Future<SyncResult> Function(SyncItem)? _syncFunction;

  /// ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
  DateTime? _lastSyncTime;  /// Ø¢Ø®Ø± Ù…Ø±Ø© ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­
  String? _lastError;        /// Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£

  /// Getters Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
  bool get isSyncing => _isSyncing;
  DateTime? get lastSyncTime => _lastSyncTime;
  String? get lastError => _lastError;

  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// ğŸ”— setSyncFunction - ØªØ¹ÙŠÙŠÙ† Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ///
  /// Ø§Ù„Ù‡Ø¯Ù: ØªØ­Ø¯ÙŠØ¯ "ÙƒÙŠÙÙŠØ© Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯"
  ///
  /// Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (ÙÙŠ main.dart):
  /// ```
  /// SyncManager.instance.setSyncFunction((SyncItem item) async {
  ///   if (item.type == SyncItemType.trip) {
  ///     return await tripRepository.syncTrip(item.data);
  ///   } else if (item.type == SyncItemType.alert) {
  ///     return await alertRepository.syncAlert(item.data);
  ///   }
  /// });
  /// ```
  ///
  /// Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø¯Ø§Ù„Ø©:
  /// syncFn = Ø¯Ø§Ù„Ø© ØªØ£Ø®Ø° SyncItem ÙˆØªØ±Ø¬Ø¹ SyncResult (Ù†Ø¬Ø§Ø­ Ø£Ùˆ ÙØ´Ù„)

  void setSyncFunction(Future<SyncResult> Function(SyncItem) syncFn) {
    _syncFunction = syncFn;
    debugPrint('ğŸ”„ [SyncManager] ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
  }

  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// â±ï¸ setSyncInterval - ØªØºÙŠÙŠØ± ÙØªØ±Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠØ©
  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ///
  /// Ø§Ù„Ù‡Ø¯Ù: ØªØºÙŠÙŠØ± Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ø¨ÙŠÙ† ÙƒÙ„ Ù…Ø²Ø§Ù…Ù†Ø© Ø¯ÙˆØ±ÙŠØ©
  ///
  /// Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:
  /// ```
  /// // ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚ (Ø¨Ø¯Ù„ 5)
  /// SyncManager.instance.setSyncInterval(Duration(minutes: 10));
  /// ```

  void setSyncInterval(Duration interval) {
    _syncInterval = interval;
    debugPrint('ğŸ”„ [SyncManager] ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙØªØ±Ø©: ${interval.inMinutes} Ø¯Ù‚ÙŠÙ‚Ø©');

    /// Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ØªØ¹Ù…Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„Ù‡Ø§ Ø¨Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    if (_syncTimer != null && _syncTimer!.isActive) {
      stopAutoSync();
      startAutoSync();
    }
  }

  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// â–¶ï¸ startAutoSync - Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ///
  /// Ø§Ù„Ù‡Ø¯Ù: ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø°ÙƒÙŠØ©
  ///
  /// Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„:
  /// 1ï¸âƒ£ Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
  ///    â†’ ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ø«Ø©
  /// 2ï¸âƒ£ Ù…Ø²Ø§Ù…Ù†Ø© Ø¯ÙˆØ±ÙŠØ© ÙƒÙ„ X Ø¯Ù‚Ø§Ø¦Ù‚
  ///    â†’ Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø£ÙŠ Ø¹Ù†Ø§ØµØ± Ù…Ø¹Ù„Ù‚Ø©
  /// 3ï¸âƒ£ Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ© Ø¹Ù†Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
  ///    â†’ Ù„Ø§ ØªÙ†ØªØ¸Ø± Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠØ©
  ///
  /// Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (ÙÙŠ app.dart):
  /// ```
  /// @override
  /// void initState() {
  ///   SyncManager.instance.startAutoSync();
  /// }
  /// ```

  Future<void> startAutoSync() async {
    /// Ù…Ù†Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ¹Ù…Ù„ Ø¨Ø§Ù„ÙØ¹Ù„)
    if (_syncTimer != null && _syncTimer!.isActive) {
      debugPrint('ğŸ”„ [SyncManager] Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø§Ù„ÙØ¹Ù„');
      return;
    }

    debugPrint('ğŸ”„ [SyncManager] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    debugPrint('ğŸ”„ [SyncManager] Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©');
    debugPrint('ğŸ”„ [SyncManager] Ø§Ù„ÙØªØ±Ø©: ${_syncInterval.inMinutes} Ø¯Ù‚ÙŠÙ‚Ø©');
    debugPrint('ğŸ”„ [SyncManager] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

    /// 1ï¸âƒ£ Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
    /// ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø²Ø§Ù…Ù†Ø© Ø£ÙŠ Ø¹Ù†Ø§ØµØ± Ù…Ø¹Ù„Ù‚Ø© Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    await syncNow();

    /// 2ï¸âƒ£ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠØ©
    /// Timer.periodic = Ù†ÙØ° syncNow() ÙƒÙ„ _syncInterval
    /// (_) = ignoring the Timer object
    _syncTimer = Timer.periodic(_syncInterval, (_) async {
      await syncNow();
    });

    /// 3ï¸âƒ£ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
    /// Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ¹ÙˆØ¯ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª (ÙƒØ§Ù† Ù…Ø¹Ø·ÙˆØ¹)
    /// Ù‚Ù… Ø¨Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ© (Ù„Ø§ ØªÙ†ØªØ¸Ø± Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠØ©)
    _connectivityService.connectionStream.listen((isConnected) {
      if (isConnected) {
        debugPrint('ğŸ”„ [SyncManager] ğŸ“¶ Ø¹ÙˆØ¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ - Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ©');
        syncNow();
      }
    });
  }

  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// â¸ï¸ stopAutoSync - Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ///
  /// Ø§Ù„Ù‡Ø¯Ù: Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠØ©
  ///
  /// Ù…ØªÙ‰ ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ØŸ
  /// - Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
  /// - Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (ÙÙŠ dispose)

  void stopAutoSync() {
    _syncTimer?.cancel();
    _syncTimer = null;
    debugPrint('ğŸ”„ [SyncManager] â¸ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©');
  }

  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// ğŸ“¤ syncNow - Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ© (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©)
  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ///
  /// Ø§Ù„Ù‡Ø¯Ù: Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø§Ù„Ø¢Ù†
  /// 
  /// Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª:
  /// 1ï¸âƒ£ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯ÙˆØ±ÙŠ (ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚)
  /// 2ï¸âƒ£ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙÙˆØ±ÙŠ (Ø¹Ù†Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª)
  /// 3ï¸âƒ£ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙŠØ¯ÙˆÙŠ (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¶ØºØ· "Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¢Ù†")
  ///
  /// Ø§Ù„Ø®Ø·ÙˆØ§Øª:
  /// 1ï¸âƒ£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
  /// 2ï¸âƒ£ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
  /// 3ï¸âƒ£ Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø²Ø§Ù…Ù†Ø© ÙƒÙ„ Ø¹Ù†ØµØ±
  /// 4ï¸âƒ£ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© (Ù†Ø¬Ø­/ÙØ´Ù„)
  /// 5ï¸âƒ£ Ø¥Ø±Ø³Ø§Ù„ Status Stream Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©

  Future<void> syncNow() async {
    /// Ù…Ù†Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬Ø©
    /// Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ø§Ø±ÙŠØ© Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù„Ø§ ØªØ¨Ø¯Ø£ Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©
    if (_isSyncing) {
      debugPrint('ğŸ”„ [SyncManager] Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ø§Ø±ÙŠØ© Ø¨Ø§Ù„ÙØ¹Ù„...');
      return;
    }

    /// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ¹ÙŠÙŠÙ† Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
    /// Ø¨Ø¯ÙˆÙ† Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø©ØŒ Ù„Ø§ Ù†Ø³ØªØ·ÙŠØ¹ Ù…Ø²Ø§Ù…Ù†Ø© Ø£ÙŠ Ø´ÙŠØ¡!
    if (_syncFunction == null) {
      debugPrint('ğŸ”„ [SyncManager] âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
      return;
    }

    /// ğŸŒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
    final isConnected = _connectivityService.isConnected;

    /// Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø§ØªØµØ§Ù„ (Ù…Ø§ Ø¹Ø¯Ø§ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±)
    if (!isConnected && !kDebugMode) {
      debugPrint('ğŸ”„ [SyncManager] ğŸ“´ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ - ØªØ£Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');

      /// Ø¥Ø±Ø³Ø§Ù„ Ø­Ø§Ù„Ø©: Ù…Ø¹Ù„Ù‚Ø© (Ù„Ø§ Ø¥Ù†ØªØ±Ù†Øª)
      /// Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø³ØªØ¹Ø±Ø¶: "Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª"
      _emitStatus(
        isSyncing: false,
        pendingCount: await _syncService.getPendingCount(),
        lastError: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª',
      );
      return;
    }

    /// ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±ØŒ Ø­Ø§ÙˆÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ÙŠÙƒØªØ´Ù Ø§ØªØµØ§Ù„Ø§Ù‹
    if (!isConnected && kDebugMode) {
      debugPrint('ğŸ”„ [SyncManager] âš ï¸ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±: Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø±ØºÙ… Ø¹Ø¯Ù… Ø§ÙƒØªØ´Ø§Ù Ø§ØªØµØ§Ù„');
    }

    /// Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    _isSyncing = true;
    _lastError = null;

    try {
      debugPrint('ğŸ”„ [SyncManager] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      debugPrint('ğŸ”„ [SyncManager] Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¢Ù†...');

      /// Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
      final pendingItems = await _syncService.getPendingItems();
      final totalItems = pendingItems.length;

      /// Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¹Ù†Ø§ØµØ± Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©
      if (totalItems == 0) {
        debugPrint('ğŸ”„ [SyncManager] âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
        _lastSyncTime = DateTime.now();

        /// Ø¥Ø±Ø³Ø§Ù„ Ø­Ø§Ù„Ø©: Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Ù„Ø§ Ø´ÙŠØ¡ Ù…Ø¹Ù„Ù‚)
        _emitStatus(
          isSyncing: false,
          pendingCount: 0,
          lastError: null,
        );
        return;
      }

      debugPrint('ğŸ”„ [SyncManager] Ø¹Ù†Ø§ØµØ± Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©: $totalItems');

      /// Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¬Ø§Ø­ ÙˆØ§Ù„ÙØ´Ù„
      int successCount = 0;
      int failCount = 0;

      /// ğŸ”„ Ù…Ø¹Ø§Ù„Ø¬Ø© ÙƒÙ„ Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯ ØªÙ„Ùˆ Ø§Ù„Ø¢Ø®Ø±
      for (int i = 0; i < pendingItems.length; i++) {
        final item = pendingItems[i];

        /// ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù… (Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©)
        /// Ù…Ø«Ù„: "Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© 3/10" (3 Ù…Ù† 10)
        final progress = (i + 1) / totalItems;
        _emitStatus(
          isSyncing: true,
          pendingCount: totalItems - i,
          progress: progress,
        );

        /// Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ù†ØµØ±
        final result = await _syncFunction!(item);

        /// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©
        if (result.success) {
          /// Ù†Ø¬Ø­Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©!
          successCount++;

          /// Ø§Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
          await _syncService.removeFromSyncQueue(item.id);

          debugPrint('ğŸ”„ [SyncManager] âœ… [$i/$totalItems] ${item.type.name}');
        } else {
          /// ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
          failCount++;
          _lastError = result.error;

          /// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ´Ù„
          final updatedItem = item.copyWith(
            attempts: item.attempts + 1,          /// Ø²ÙŠØ§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª
            lastAttempt: DateTime.now(),          /// ÙˆÙ‚Øª Ø¢Ø®Ø± Ù…Ø­Ø§ÙˆÙ„Ø©
            error: result.error,                  /// Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
            status: SyncItemStatus.failed,        /// ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù†ØµØ±: ÙØ´Ù„
          );

          /// Ø§Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„ÙØ§Ø´Ù„ (Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹)
          await _syncService.addToSyncQueue(updatedItem);

          debugPrint('ğŸ”„ [SyncManager] âŒ [$i/$totalItems] ${item.type.name}: ${result.error}');

          /// Ø§Ù„ØªÙˆÙ‚Ù Ø¹Ù†Ø¯ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
          /// Ù…Ø«Ù„: 5 Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙØ§Ø´Ù„Ø© = ØªÙˆÙ‚Ù Ù†Ù‡Ø§Ø¦ÙŠ
          if (updatedItem.attempts >= AppConfig.syncMaxRetries) {
            debugPrint('ğŸ”„ [SyncManager] âš ï¸ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª: ${item.localId}');
          }
        }

        /// ØªØ£Ø®ÙŠØ± ØµØºÙŠØ± (100ms) Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ©
        /// (Ø®Ø§Ø¯Ù… Firebase Ù‚Ø¯ ÙŠØ±ÙØ¶Ùƒ Ø¥Ø°Ø§ Ø£Ø±Ø³Ù„Øª Ø·Ù„Ø¨Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ø¬Ø¯Ø§Ù‹)
        await Future.delayed(const Duration(milliseconds: 100));
      }

      /// ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©
      _lastSyncTime = DateTime.now();

      /// Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„Ø®Øµ
      debugPrint('ğŸ”„ [SyncManager] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      debugPrint('ğŸ”„ [SyncManager] âœ… Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
      debugPrint('ğŸ”„ [SyncManager] Ù†Ø¬Ø­Øª: $successCount');
      debugPrint('ğŸ”„ [SyncManager] ÙØ´Ù„Øª: $failCount');
      debugPrint('ğŸ”„ [SyncManager] Ø§Ù„ÙˆÙ‚Øª: $_lastSyncTime');
      debugPrint('ğŸ”„ [SyncManager] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      /// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
      final remainingCount = await _syncService.getPendingCount();
      _emitStatus(
        isSyncing: false,
        pendingCount: remainingCount,
        lastError: failCount > 0 ? _lastError : null,
      );

    } catch (e, stackTrace) {
      /// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ØºÙŠØ± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
      _lastError = e.toString();
      debugPrint('ğŸ”„ [SyncManager] âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: $e');
      debugPrint('ğŸ”„ [SyncManager] Stack: $stackTrace');

      /// Ø¥Ø±Ø³Ø§Ù„ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
      _emitStatus(
        isSyncing: false,
        pendingCount: await _syncService.getPendingCount(),
        lastError: _lastError,
      );
    } finally {
      /// ØªÙˆÙ‚Ù Ø§Ù„Ø­Ø§Ù„Ø©: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©"
      _isSyncing = false;
    }
  }

  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// ğŸ”„ fullSync - Ù…Ø²Ø§Ù…Ù†Ø© ÙƒØ§Ù…Ù„Ø© (Push + Pull)
  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ///
  /// Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† syncNow Ùˆ fullSync:
  /// 
  /// syncNow():
  /// - ØªØ±Ø³Ù„ (Push) Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø¥Ù„Ù‰ Firebase ÙÙ‚Ø·
  /// - Ù…Ø­Ù„ÙŠ â† Firebase
  /// 
  /// fullSync():
  /// - ØªØ±Ø³Ù„ (Push) Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
  /// - ØªØ¬Ù„Ø¨ (Pull) Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† Firebase
  /// - Ù…Ø­Ù„ÙŠ â†” Firebase (Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ø§ØªØ¬Ø§Ù‡)
  ///
  /// Ù…ØªÙ‰ Ù†Ø³ØªØ®Ø¯Ù… fullSyncØŸ
  /// - Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ (ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ø­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
  /// - Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù…Ù† Ø­Ø³Ø§Ø¨ Ù„Ø¢Ø®Ø±
  /// - Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© Ù„ØªØ­Ø¯ÙŠØ« ÙƒØ§Ù…Ù„

  Future<void> fullSync() async {
    debugPrint('ğŸ”„ [SyncManager] Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©...');

    /// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
    if (!_connectivityService.isConnected && !kDebugMode) {
      debugPrint('ğŸ”„ [SyncManager] ğŸ“´ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ - Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©');
      return;
    }

    try {
      /// 1ï¸âƒ£ Ø¯ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Push)
      /// Ø§Ø±Ø³Ù„ ÙƒÙ„ Ø¹Ù†Ø§ØµØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
      await syncNow();

      /// 2ï¸âƒ£ Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Pull)
      /// Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
      await _syncService.pullFromFirestore();

      debugPrint('ğŸ”„ [SyncManager] âœ… Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©');
    } catch (e) {
      debugPrint('ğŸ”„ [SyncManager] âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©: $e');
    }
  }

  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// ğŸ“ addToQueue - Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ///
  /// Ø§Ù„Ù‡Ø¯Ù: Ø¹Ù†Ø¯Ù…Ø§ ØªØ­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø£Ø¶ÙÙ‡Ø§ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©
  ///
  /// Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (ÙÙŠ Repositories):
  /// ```
  /// // ÙÙŠ TripRepositoryImpl
  /// await tripRepository.startTrip(trip);
  /// 
  /// // Ø£Ø¶Ù Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©
  /// final syncItem = SyncItem(
  ///   id: trip.id,
  ///   type: SyncItemType.trip,
  ///   data: trip.toJson(),
  /// );
  /// await SyncManager.instance.addToQueue(syncItem);
  /// ```

  Future<void> addToQueue(SyncItem item) async {
    /// Ø£Ø¶Ù Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
    await _syncService.addToSyncQueue(item);
    debugPrint('ğŸ”„ [SyncManager] ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©: ${item.type.name}');

    /// Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ù…ØªÙˆÙØ±Ø§Ù‹
    if (_connectivityService.isConnected) {
      debugPrint('ğŸ”„ [SyncManager] Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©...');
      await syncNow();
    } else {
      debugPrint('ğŸ”„ [SyncManager] Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ - Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ø§ØªØµØ§Ù„');
    }
  }

  /// ğŸ”” syncStatusStream - Stream Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
  /// Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªØ³ØªÙ…Ø¹ Ù„Ù‡Ø°Ø§ Ù„ØªØ¹Ø±Ù:
  /// - Ù‡Ù„ Ø¬Ø§Ø±ÙŠØ© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©ØŸ
  /// - ÙƒÙ… Ø¹Ù†ØµØ± Ù…Ø¹Ù„Ù‚ØŸ
  Stream<SyncStatus> get syncStatusStream => _syncStatusController.stream;

  /// ğŸ“¢ _emitStatus - Ø¥Ø±Ø³Ø§Ù„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Ø¯Ø§Ø®Ù„ÙŠ)
  void _emitStatus({
    required bool isSyncing,
    required int pendingCount,
    String? lastError,
    double progress = 0.0,
  }) {
    final status = SyncStatus(
      isSyncing: isSyncing,
      lastSyncTime: _lastSyncTime,
      pendingCount: pendingCount,
      lastError: lastError,
      progress: progress,
    );

    /// Ø£Ø±Ø³Ù„ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
    _syncStatusController.add(status);
  }

  /// ğŸ”„ retryFailed - Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§Ø´Ù„Ø©
  Future<void> retryFailed() async {
    debugPrint('ğŸ”„ [SyncManager] Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§Ø´Ù„Ø©...');
    await _syncService.retryFailedItems();
  }

  /// ğŸ‘¤ getCurrentUserId - Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  Future<String?> getCurrentUserId() async {
    return FirebaseAuth.instance.currentUser?.uid;
  }

  /// ğŸ“Š getCurrentStatus - Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  Future<SyncStatus> getCurrentStatus() async {
    final pendingCount = await _syncService.getPendingCount();

    return SyncStatus(
      isSyncing: _isSyncing,
      lastSyncTime: _lastSyncTime,
      pendingCount: pendingCount,
      lastError: _lastError,
      progress: 0.0,
    );
  }

  /// ğŸ§¹ dispose - ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
  /// Ù…ØªÙ‰ ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ØŸ
  /// Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£Ùˆ ÙÙŠ main.dart
  void dispose() {
    _syncTimer?.cancel();
    _syncStatusController.close();
    debugPrint('ğŸ”„ [SyncManager] ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯');
  }
}
