import 'package:hive/hive.dart';
import '../../features/trips/data/models/deviation_model.dart';

/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/// ğŸ›£ï¸ DeviationModelAdapter - Ø§Ù„Ù…Ø­ÙˆÙ‘Ù„ Ø§Ù„Ø®Ø§Øµ Ø¨ØªØ®Ø²ÙŠÙ† ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø§Ù†Ø­Ø±Ø§ÙØ§Øª Ø¹Ù† Ø§Ù„Ù…Ø³Ø§Ø±
/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/// 
/// ğŸ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Clean Architecture:
/// - Ø§Ù„Ø·Ø¨Ù‚Ø©: Core Layer > Adapters
/// - Ø§Ù„ÙˆØ¸ÙŠÙØ©: ØªØ­ÙˆÙŠÙ„ DeviationModel (Ø§Ù†Ø­Ø±Ø§Ù Ø¹Ù† Ø§Ù„Ù…Ø³Ø§Ø±) Ù…Ù†/Ø¥Ù„Ù‰ Binary
/// 
/// ğŸ“Œ Ù…Ø§ Ù‡Ùˆ DeviationØŸ
/// Deviation Ù‡Ùˆ "Ø³Ø¬Ù„ Ø®Ø±ÙˆØ¬" Ø¹Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø®Ø·Ø·:
/// - Ù…ØªÙ‰ Ø®Ø±Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù† Ø§Ù„Ù…Ø³Ø§Ø±ØŸ
/// - Ø£ÙŠÙ† Ø®Ø±Ø¬ Ø¨Ø§Ù„Ø¶Ø¨Ø·ØŸ (location)
/// - ÙƒÙ… Ù…ØªØ± Ø®Ø±Ø¬ØŸ (distance)
/// - Ù‡Ù„ Ø¹Ø§Ø¯ Ù„Ù„Ù…Ø³Ø§Ø±ØŸ (resolved)
/// - ÙƒÙ… Ø§Ø³ØªØºØ±Ù‚ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø³Ø§Ø±ØŸ (duration)
/// 
/// ğŸ’¡ Ù…Ø«Ø§Ù„ ÙˆØ§Ù‚Ø¹ÙŠ:
/// Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø±Ø­Ù„Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØª Ù„Ù„Ø¹Ù…Ù„:
/// ```
/// Deviation {
///   id: "deviation_1",
///   tripId: "trip_123",
///   detectedAt: DateTime(2024, 1, 15, 8, 30),   // Ø§Ù„Ø³Ø§Ø¹Ø© 8:30 Øµ
///   location: LocationModel(...),                 // Ø£ÙŠÙ† Ø®Ø±Ø¬ØŸ
///   distance: 500.0,                              // 500 Ù…ØªØ± Ø¹Ù† Ø§Ù„Ù…Ø³Ø§Ø±
///   severity: DeviationSeverity.medium,           // Ù…ØªÙˆØ³Ø· Ø§Ù„Ø®Ø·ÙˆØ±Ø©
///   resolved: true,                               // Ø¹Ø§Ø¯ Ù„Ù„Ù…Ø³Ø§Ø± âœ…
///   resolvedAt: DateTime(2024, 1, 15, 8, 35),    // Ø¹Ø§Ø¯ Ø¨Ø¹Ø¯ 5 Ø¯Ù‚Ø§Ø¦Ù‚
///   alertSent: true,                              // ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡
///   reason: "ØªØ¬Ù†Ø¨ Ø²Ø­Ø§Ù…"                          // Ø³Ø¨Ø¨ Ø§Ø®ØªÙŠØ§Ø±ÙŠ
/// }
/// ```
/// 
/// ğŸ”¢ typeId = 9

class DeviationModelAdapter extends TypeAdapter<DeviationModel> {
  @override
  final int typeId = 9;

  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// ğŸ“– read() - Ù‚Ø±Ø§Ø¡Ø© DeviationModel Ù…Ù† Hive
  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// 
  /// ğŸ¯ Ù…ØªÙ‰ ØªÙØ³ØªØ¯Ø¹Ù‰ØŸ
  /// - Ø¹Ù†Ø¯ Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø­Ø±Ø§ÙØ§Øª ÙÙŠ Ø±Ø­Ù„Ø©
  /// - Ø¹Ù†Ø¯ ØªØ­Ù„ÙŠÙ„ Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© (Ù‡Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ®Ø±Ø¬ Ø¹Ù† Ø§Ù„Ù…Ø³Ø§Ø± ÙƒØ«ÙŠØ±Ø§Ù‹ØŸ)
  /// - Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø±Ø­Ù„Ø©
  /// 
  /// âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø© Ø®Ø§ØµØ©:
  /// Ø¹Ù„Ù‰ Ø¹ÙƒØ³ Adapters Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©ØŒ Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… writeMap/readMap
  /// Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† writeByte/readByte. Ù„Ù…Ø§Ø°Ø§ØŸ
  /// 
  /// ğŸ’¡ Ø§Ù„Ø³Ø¨Ø¨:
  /// DeviationModel Ù‚Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ„ Ù…Ø¹Ù‚Ø¯Ø© ÙˆÙ…ØªØºÙŠØ±Ø©
  /// (Ù…Ø«Ù„ metadata Ø¥Ø¶Ø§ÙÙŠØ©)ØŒ ÙˆØ·Ø±ÙŠÙ‚Ø© Map Ø£Ø³Ù‡Ù„ ÙÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©
  /// ÙˆØ£ÙƒØ«Ø± Ù…Ø±ÙˆÙ†Ø© Ù„Ù„ØªÙˆØ³Ø¹ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ
  @override
  DeviationModel read(BinaryReader reader) {
    /// Ù†Ù‚Ø±Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ€ Map Ù…Ø¨Ø§Ø´Ø±Ø©
    /// Hive ØªØ­ÙˆÙ„ Map â†’ Binary â†’ Map ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    final map = Map<String, dynamic>.from(reader.readMap());
    
    /// Ù†Ø­ÙˆÙ„ Ø£ÙŠ Maps Ø¯Ø§Ø®Ù„ÙŠØ© (nested) Ù…Ù† dynamic Ø¥Ù„Ù‰ typed
    return DeviationModel.fromJson(_convertMap(map));
  }

  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// ğŸ’¾ write() - Ø­ÙØ¸ DeviationModel ÙÙŠ Hive
  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// 
  /// ğŸ¯ Ù…ØªÙ‰ ØªÙØ³ØªØ¯Ø¹Ù‰ØŸ
  /// - Ø¹Ù†Ø¯ Ø±ØµØ¯ Ø§Ù†Ø­Ø±Ø§Ù Ø¬Ø¯ÙŠØ¯ (ÙƒÙ„ Ù…Ø±Ø© ÙŠØ®Ø±Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù† Ø§Ù„Ù…Ø³Ø§Ø±!)
  /// - Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù (resolved â†’ true)
  /// - Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø³Ø¨Ø¨ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù (reason)
  @override
  void write(BinaryWriter writer, DeviationModel obj) {
    /// Ù†ÙƒØªØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ€ Map Ù…Ø¨Ø§Ø´Ø±Ø©
    /// Ø£Ø¨Ø³Ø· ÙˆØ£Ø³Ù‡Ù„ Ù…Ù† writeByte Ù„ÙƒÙ„ Ø­Ù‚Ù„!
    writer.writeMap(obj.toJson());
  }

  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// ğŸ› ï¸ Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ­ÙˆÙŠÙ„
  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// 
  /// ğŸ’¡ Ù„Ù…Ø§Ø°Ø§ Ù†Ø­ØªØ§Ø¬ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„ØŸ
  /// Hive ØªØ±Ø¬Ø¹ Map<dynamic, dynamic> (Ù…ÙØ§ØªÙŠØ­ ÙˆÙ‚ÙŠÙ… Ù…Ù† Ø£ÙŠ Ù†ÙˆØ¹)
  /// Ù„ÙƒÙ†Ù†Ø§ Ù†Ø­ØªØ§Ø¬ Map<String, dynamic> (Ù…ÙØ§ØªÙŠØ­ StringØŒ Ù‚ÙŠÙ… Ø£ÙŠ Ù†ÙˆØ¹)
  /// 
  /// Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„ ØªØ­ÙˆÙ„ recursively (Ø¨Ø´ÙƒÙ„ Ù…ØªÙƒØ±Ø±) ÙƒÙ„ Maps Ùˆ Lists
  
  /// ØªØ­ÙˆÙŠÙ„ Map Ù…Ù† dynamic â†’ String keys
  Map<String, dynamic> _convertMap(Map<dynamic, dynamic> map) {
    return map.map((key, value) {
      if (value is Map) {
        /// Ø¥Ø°Ø§ Ø§Ù„Ù‚ÙŠÙ…Ø© MapØŒ Ù†Ø­ÙˆÙ„Ù‡Ø§ recursively
        return MapEntry(key.toString(), _convertMap(value));
      } else if (value is List) {
        /// Ø¥Ø°Ø§ Ø§Ù„Ù‚ÙŠÙ…Ø© ListØŒ Ù†Ø­ÙˆÙ„Ù‡Ø§ recursively
        return MapEntry(key.toString(), _convertList(value));
      }
      /// Ù‚ÙŠÙ…Ø© Ø¹Ø§Ø¯ÙŠØ©ØŒ Ù†Ø­ÙˆÙ„ Ø§Ù„Ù…ÙØªØ§Ø­ ÙÙ‚Ø·
      return MapEntry(key.toString(), value);
    });
  }

  /// ØªØ­ÙˆÙŠÙ„ List - Ù†Ù…Ø± Ø¹Ù„Ù‰ ÙƒÙ„ Ø¹Ù†ØµØ± ÙˆÙ†Ø­ÙˆÙ„Ù‡
  List<dynamic> _convertList(List<dynamic> list) {
    return list.map((item) {
      if (item is Map) {
        return _convertMap(item);
      } else if (item is List) {
        return _convertList(item);
      }
      return item;
    }).toList();
  }
}

/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/// ğŸ“ Ø®Ù„Ø§ØµØ© Ø¹Ù† Ø§Ù„Ø§Ù†Ø­Ø±Ø§ÙØ§Øª:
/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/// 
/// ğŸš¨ ÙƒÙŠÙ ÙŠØªÙ… Ø±ØµØ¯ Ø§Ù„Ø§Ù†Ø­Ø±Ø§ÙØŸ
/// 
/// ```dart
/// // ÙÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„ØªØªØ¨Ø¹ (DeviationDetector):
/// Timer.periodic(Duration(seconds: 10), (_) async {
///   final currentLocation = await LocationService.getCurrentLocation();
///   final plannedRoute = currentTrip.route;
///   
///   // Ø§Ø­Ø³Ø¨ Ø£Ù‚Ø±Ø¨ Ù†Ù‚Ø·Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø®Ø·Ø·
///   final nearestPoint = findNearestPointOnRoute(
///     currentLocation, 
///     plannedRoute.polylinePoints
///   );
///   
///   // Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
///   final deviationDistance = calculateDistance(
///     currentLocation, 
///     nearestPoint
///   );
///   
///   // Ø¥Ø°Ø§ Ø®Ø±Ø¬ Ø£ÙƒØ«Ø± Ù…Ù† 200 Ù…ØªØ± = Ø§Ù†Ø­Ø±Ø§Ù!
///   if (deviationDistance > 200) {
///     // Ø³Ø¬Ù„ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù
///     final deviation = DeviationModel(
///       id: 'deviation_${DateTime.now().millisecondsSinceEpoch}',
///       tripId: currentTrip.id,
///       detectedAt: DateTime.now(),
///       location: currentLocation,
///       distance: deviationDistance,
///       severity: calculateSeverity(deviationDistance),
///       resolved: false,  // Ù„Ù… ÙŠØ¹Ø¯ Ø¨Ø¹Ø¯
///       alertSent: false,
///     );
///     
///     // Ø§Ø­ÙØ¸ ÙÙŠ Hive (Adapter ÙŠØ´ØªØºÙ„ Ù‡Ù†Ø§!)
///     await deviationBox.put(deviation.id, deviation);
///     
///     // Ø£Ø±Ø³Ù„ ØªÙ†Ø¨ÙŠÙ‡
///     await sendDeviationAlert(deviation);
///   }
/// });
/// ```
/// 
/// ğŸ“Š Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø®Ø·ÙˆØ±Ø© (Severity):
/// - low (< 300m): "Ø®Ø±Ø¬Øª Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¹Ù† Ø§Ù„Ù…Ø³Ø§Ø±"
/// - medium (300-1000m): "Ø®Ø±Ø¬Øª Ø¹Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ù…Ø³Ø§ÙØ© ÙƒØ¨ÙŠØ±Ø©!"
/// - high (> 1000m): "Ø£Ù†Øª Ø¨Ø¹ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ Ø¹Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø®Ø·Ø·!"
/// 
/// ğŸ’¡ ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…ÙÙŠØ¯Ø© Ù…Ù† Deviations:
/// 
/// 1ï¸âƒ£ **Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©:**
///    - Ù‡Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ®Ø±Ø¬ ÙƒØ«ÙŠØ±Ø§Ù‹ØŸ (Ø±Ø¨Ù…Ø§ ÙŠØ­ØªØ§Ø¬ Ø·Ø±Ù‚ Ø¨Ø¯ÙŠÙ„Ø©)
///    - ÙÙŠ Ø£ÙŠ Ø£ÙˆÙ‚Ø§Øª ÙŠØ®Ø±Ø¬ Ø¹Ù† Ø§Ù„Ù…Ø³Ø§Ø±ØŸ (Ø±Ø¨Ù…Ø§ Ø²Ø­Ø§Ù… Ù…Ø¹ÙŠÙ†)
///    
/// 2ï¸âƒ£ **ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª:**
///    - Ø¥Ø°Ø§ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙŠØ®Ø±Ø¬ÙˆÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù†Ù‚Ø·Ø©
///      â†’ Ø±Ø¨Ù…Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­ ØºÙŠØ± Ø¹Ù…Ù„ÙŠ!
///    
/// 3ï¸âƒ£ **Ø§Ù„Ø£Ù…Ø§Ù†:**
///    - Ø§Ù†Ø­Ø±Ø§ÙØ§Øª Ù…ØªÙƒØ±Ø±Ø© ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ù…Ø¹ÙŠÙ†Ø©
///      â†’ Ø±Ø¨Ù…Ø§ Ù…Ù†Ø·Ù‚Ø© Ø®Ø·Ø±Ø© Ø£Ùˆ Ù…Ø­ÙŠØ±Ø©
/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
